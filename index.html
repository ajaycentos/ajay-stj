<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swing Trading Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #auth-overlay, #loader-overlay, #trade-modal-overlay, #close-trade-modal-overlay, #reports-modal-overlay, #add-note-modal-overlay {
            background-color: rgba(241, 245, 249, 0.95);
            backdrop-filter: blur(8px);
        }
        .status-tag {
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 9999px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-open { background-color: #e0e7ff; color: #4338ca; }
        .status-win { background-color: #dcfce7; color: #166534; }
        .status-loss { background-color: #fee2e2; color: #991b1b; }
        .status-be { background-color: #f1f5f9; color: #475569; }
        
        .stat-card h3 {
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
        }
        .stat-card p {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
        }
        .pnl-positive { color: #16a34a; }
        .pnl-negative { color: #dc2626; }
        
        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day {
            aspect-ratio: 1 / 1; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            border-radius: 8px; 
            background-color: #f8fafc;
            font-size: 0.75rem; 
            cursor: pointer; 
            transition: background-color 0.2s;
            padding: 2px;
        }
        .calendar-day:hover { background-color: #f1f5f9; }
        .calendar-day.today { font-weight: bold; border: 2px solid #4f46e5; }
        .calendar-day.selected { background-color: #e0e7ff; border: 2px solid #4338ca; }
        .calendar-day .trades {
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            gap: 6px;
            margin-top: 2px;
        }
        .calendar-day .buys { color: #16a34a; }
        .calendar-day .sells { color: #dc2626; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-start justify-center min-h-screen pt-8 sm:pt-12">

    <main id="app-container" class="w-full max-w-6xl mx-auto p-4" style="display: none;">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl font-bold text-slate-900">Swing Trading Journal</h1>
            <p id="current-date" class="text-slate-500">Track your trades, improve your edge.</p>
            <div id="user-info" class="absolute top-0 right-0 text-right">
                <button id="logout-button" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Logout</button>
            </div>
        </header>

        <section id="stats-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-8">
            <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                <h3>Total P&L</h3>
                <p id="total-pnl">₹0</p>
            </div>
            <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                <h3>Win Rate</h3>
                <p id="win-rate">0%</p>
            </div>
            <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                <h3>Avg. Win / Loss</h3>
                <p id="avg-win-loss">₹0 / ₹0</p>
            </div>
            <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                <h3>Open Trades</h3>
                <p id="open-trades-count">0</p>
            </div>
             <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                <h3>Profit Factor</h3>
                <p id="profit-factor">0.0</p>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <div class="flex justify-center bg-slate-200 p-1 rounded-lg w-full sm:w-auto">
                         <button id="open-trades-tab" class="tab-btn active">Open</button>
                         <button id="closed-trades-tab" class="tab-btn">Closed</button>
                    </div>
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <button id="view-reports-button" class="w-full sm:w-auto text-sm font-semibold text-indigo-600 hover:bg-indigo-100 py-3 px-4 rounded-lg transition">View Reports</button>
                        <button id="log-trade-button" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition shadow-lg">Log New Trade</button>
                    </div>
                </div>

                <section id="trades-list-section">
                    <div id="trades-header" class="flex justify-between items-center mb-3 px-2">
                        <h2 id="trades-list-header" class="text-xl font-semibold">Open Trades</h2>
                        <button id="clear-date-filter" class="text-sm font-semibold text-indigo-600 hover:underline" style="display: none;">View All</button>
                    </div>
                    <ul id="trades-list" class="space-y-3">
                        </ul>
                </section>
            </div>
            
            <div class="lg:col-span-1">
                <section id="calendar-section" class="mt-4 lg:mt-0">
                    <h2 class="text-xl font-semibold mb-3 px-2">Trade History</h2>
                    <div class="bg-white p-4 rounded-2xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="p-2 rounded-full hover:bg-slate-100">&lt;</button>
                            <h3 id="month-year" class="font-bold text-lg"></h3>
                            <button id="next-month" class="p-2 rounded-full hover:bg-slate-100">&gt;</button>
                        </div>
                        <div class="calendar-grid text-center text-xs font-semibold text-slate-500 mb-2">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-body" class="calendar-grid"></div>
                    </div>
                </section>
            </div>
        </div>
    </main>
    
    <div id="trade-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="w-full max-w-lg bg-white p-6 rounded-2xl shadow-xl space-y-4">
            <div class="flex justify-between items-center">
                <h2 id="trade-modal-title" class="text-xl font-bold">Log New Trade</h2>
                <button id="close-trade-modal-button" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <form id="trade-form" class="space-y-3">
                <input type="hidden" id="trade-id-input">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <input type="text" id="ticker-input" placeholder="Ticker (e.g., RELIANCE)" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="strategy-input" placeholder="Setup/Strategy (e.g. Supertrend)" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-500">Entry Date</label>
                        <input type="date" id="entry-date-input" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                         <label class="text-xs text-slate-500">Direction</label>
                        <select id="direction-select" class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option>Long</option>
                            <option>Short</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-2 gap-3">
                    <input type="number" step="any" id="entry-price-input" placeholder="Entry Price" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="quantity-input" placeholder="Quantity" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <textarea id="entry-notes-input" placeholder="Entry Notes / Trade Thesis..." rows="3" class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <button type="submit" id="save-trade-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700">Save Trade</button>
            </form>
        </div>
    </div>
    
    <div id="close-trade-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
         <div class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-xl space-y-4">
             <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Close Trade</h2>
                <button id="cancel-close-trade-button" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
             <form id="close-trade-form" class="space-y-3">
                <input type="hidden" id="close-trade-id-input">
                <div>
                    <label class="text-xs text-slate-500">Exit Date</label>
                    <input type="date" id="exit-date-input" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                     <label class="text-xs text-slate-500">Exit Price</label>
                    <input type="number" step="any" id="exit-price-input" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <textarea id="exit-notes-input" placeholder="Exit Notes / Trade Review..." rows="3" class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <button type="submit" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700">Confirm Close</button>
            </form>
         </div>
    </div>

    <div id="reports-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="w-full max-w-4xl h-full max-h-[90vh] bg-white p-6 rounded-2xl shadow-xl space-y-4 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Performance Reports</h2>
                <button id="close-reports-modal-button" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div class="space-y-8">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-center">Cumulative P&L</h3>
                    <canvas id="cumulative-pnl-chart"></canvas>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-center">P&L by Strategy</h3>
                    <canvas id="strategy-pnl-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="add-note-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl space-y-4">
            <div class="flex justify-between items-center">
                <h2 id="add-note-modal-title" class="text-xl font-bold">Add Daily Note</h2>
                <button id="cancel-add-note-button" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <form id="add-note-form" class="space-y-3">
                <input type="hidden" id="add-note-trade-id-input">
                <div>
                    <label class="text-xs text-slate-500">Note Date</label>
                    <input type="date" id="note-date-input" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <textarea id="note-text-input" placeholder="How did the stock perform today? Any new observations..." rows="4" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700">Save Note</button>
            </form>
        </div>
    </div>

    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl text-center">
            <h2 class="text-2xl font-bold mb-2 text-slate-800">Trading Journal</h2>
            <p class="text-slate-500 mb-6">Sign in to begin.</p>
            <button id="google-signin-button" class="w-full bg-white border border-slate-300 text-slate-700 font-semibold py-3 px-5 rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-3">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.226-11.283-7.662l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.24 44 30.025 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Sign in with Google
            </button>
            <p id="auth-error" class="text-red-500 text-sm mt-4 h-4"></p>
        </div>
    </div>
    <div id="loader-overlay" class="fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
        <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
    </div>

    <script type="module">
        // --- SCRIPT VERSION 4.0 (ADDED DAILY NOTES FEATURE) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
			apiKey: "AIzaSyD8rRXlt8gwrKMIgLTwhvejWCiIPOqEMl0",
            authDomain: "my-habit-tracker-fab33.firebaseapp.com",
            projectId: "my-habit-tracker-fab33",
            storageBucket: "my-habit-tracker-fab33.appspot.com",
            messagingSenderId: "76678091008",
            appId: "1:76678091008:web:beb64e97a88f1f04fa63e5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const appContainer = document.getElementById('app-container');
            const authOverlay = document.getElementById('auth-overlay');
            const loaderOverlay = document.getElementById('loader-overlay');
            const googleSigninButton = document.getElementById('google-signin-button');
            const authError = document.getElementById('auth-error');
            const logoutButton = document.getElementById('logout-button');
            const dateElement = document.getElementById('current-date');
            const logTradeButton = document.getElementById('log-trade-button');
            const tradesList = document.getElementById('trades-list');
            const tradesListHeader = document.getElementById('trades-list-header');
            const clearDateFilter = document.getElementById('clear-date-filter');

            // Modals & Reports
            const tradeModalOverlay = document.getElementById('trade-modal-overlay');
            const closeTradeModalButton = document.getElementById('close-trade-modal-button');
            const tradeModalTitle = document.getElementById('trade-modal-title');
            const tradeForm = document.getElementById('trade-form');
            const tradeIdInput = document.getElementById('trade-id-input');
            const closeTradeModalOverlay = document.getElementById('close-trade-modal-overlay');
            const closeTradeForm = document.getElementById('close-trade-form');
            const cancelCloseTradeButton = document.getElementById('cancel-close-trade-button');
            const closeTradeIdInput = document.getElementById('close-trade-id-input');
            const reportsModalOverlay = document.getElementById('reports-modal-overlay');
            const closeReportsModalButton = document.getElementById('close-reports-modal-button');
            const viewReportsButton = document.getElementById('view-reports-button');
            const addNoteModalOverlay = document.getElementById('add-note-modal-overlay');
            const addNoteForm = document.getElementById('add-note-form');
            const cancelAddNoteButton = document.getElementById('cancel-add-note-button');
            const addNoteTradeIdInput = document.getElementById('add-note-trade-id-input');
            
            // Tabs
            const openTradesTab = document.getElementById('open-trades-tab');
            const closedTradesTab = document.getElementById('closed-trades-tab');

            // Stats
            const totalPnlEl = document.getElementById('total-pnl');
            const winRateEl = document.getElementById('win-rate');
            const avgWinLossEl = document.getElementById('avg-win-loss');
            const openTradesCountEl = document.getElementById('open-trades-count');
            const profitFactorEl = document.getElementById('profit-factor');
            
            // Calendar
            const monthYearElement = document.getElementById('month-year');
            const calendarBody = document.getElementById('calendar-body');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');

            // --- APP STATE ---
            let allTrades = [];
            let currentUserId = null;
            let unsubscribeFromFirestore = null;
            let currentView = 'open'; // 'open' or 'closed'
            let cumulativePnlChart = null;
            let strategyPnlChart = null;
            let calendarDate = new Date();
            let selectedDateStr = null;

            // --- AUTHENTICATION ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loaderOverlay.style.display = 'flex';
                    currentUserId = user.uid;
                    authOverlay.style.display = 'none';
                    appContainer.style.display = 'block';
                    loadTradesFromFirestore();
                } else {
                    currentUserId = null;
                    if (unsubscribeFromFirestore) unsubscribeFromFirestore();
                    allTrades = [];
                    authOverlay.style.display = 'flex';
                    appContainer.style.display = 'none';
                    loaderOverlay.style.display = 'none';
                }
            });

            googleSigninButton.addEventListener('click', async () => {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { authError.textContent = "Could not sign in with Google."; }
            });
            logoutButton.addEventListener('click', () => signOut(auth));

            // --- FIRESTORE DATA HANDLING ---
            const loadTradesFromFirestore = () => {
                if (!currentUserId) return;
                loaderOverlay.style.display = 'flex';
                const docRef = doc(db, "traders", currentUserId);
                unsubscribeFromFirestore = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        allTrades = docSnap.data().trades || [];
                    } else {
                        allTrades = [];
                    }
                    render();
                    loaderOverlay.style.display = 'none';
                }, (error) => { console.error("Firestore read error:", error); loaderOverlay.style.display = 'none'; });
            };

            const saveDataToFirestore = async () => {
                if (!currentUserId) return;
                try {
                    const docRef = doc(db, "traders", currentUserId);
                    await setDoc(docRef, { trades: allTrades }, { merge: true });
                } catch (error) { console.error("Error saving data to Firestore: ", error); alert("Error: Could not save data."); }
            };
            
            // --- CORE TRADE LOGIC & CRUD ---
            const saveTrade = () => {
                const tradeId = tradeIdInput.value;
                const tradeData = { ticker: document.getElementById('ticker-input').value.toUpperCase(), strategy: document.getElementById('strategy-input').value, entryDate: document.getElementById('entry-date-input').value, direction: document.getElementById('direction-select').value, entryPrice: parseFloat(document.getElementById('entry-price-input').value), quantity: parseInt(document.getElementById('quantity-input').value), entryNotes: document.getElementById('entry-notes-input').value, status: 'open', };
                if (tradeId) { const index = allTrades.findIndex(t => t.id == tradeId); if (index > -1) { const existingTrade = allTrades[index]; allTrades[index] = { ...existingTrade, ...tradeData }; }
                } else { tradeData.id = Date.now(); allTrades.push(tradeData); }
                saveDataToFirestore();
                hideTradeModal();
            };

            const closeTrade = () => {
                const tradeId = closeTradeIdInput.value;
                const index = allTrades.findIndex(t => t.id == tradeId);
                if (index === -1) return;
                const exitPrice = parseFloat(document.getElementById('exit-price-input').value);
                const pnl = (exitPrice - allTrades[index].entryPrice) * allTrades[index].quantity * (allTrades[index].direction === 'Short' ? -1 : 1);
                let status = 'be';
                if (pnl > 0) status = 'win';
                if (pnl < 0) status = 'loss';
                allTrades[index] = { ...allTrades[index], exitDate: document.getElementById('exit-date-input').value, exitPrice: exitPrice, exitNotes: document.getElementById('exit-notes-input').value, status: status, pnl: pnl };
                saveDataToFirestore();
                hideCloseTradeModal();
            };

            const saveNote = () => {
                const tradeId = addNoteTradeIdInput.value;
                const noteText = document.getElementById('note-text-input').value;
                const noteDate = document.getElementById('note-date-input').value;
                const index = allTrades.findIndex(t => t.id == tradeId);
                if (index === -1) return;
                if (!allTrades[index].dailyNotes) {
                    allTrades[index].dailyNotes = [];
                }
                const newNote = { date: noteDate, text: noteText };
                allTrades[index].dailyNotes.push(newNote);
                saveDataToFirestore();
                hideAddNoteModal();
            };
            
            const deleteTrade = (tradeId) => {
                if (confirm('Are you sure you want to delete this trade? This action cannot be undone.')) { allTrades = allTrades.filter(t => t.id != tradeId); saveDataToFirestore(); }
            };

            // --- UI & RENDERING ---
            const render = () => {
                renderStats();
                renderTradesList();
                renderCharts();
                renderCalendar();
            };

            const renderStats = () => {
                const closedTrades = allTrades.filter(t => t.status !== 'open');
                const totalPnl = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                const wins = closedTrades.filter(t => t.status === 'win');
                const losses = closedTrades.filter(t => t.status === 'loss');
                const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length) * 100 : 0;
                const grossProfit = wins.reduce((sum, t) => sum + t.pnl, 0);
                const grossLoss = losses.reduce((sum, t) => sum + t.pnl, 0);
                const avgWin = wins.length > 0 ? grossProfit / wins.length : 0;
                const avgLoss = losses.length > 0 ? grossLoss / losses.length : 0;
                let profitFactor = 0;
                if (grossLoss !== 0) { profitFactor = Math.abs(grossProfit / grossLoss); } else if (grossProfit > 0) { profitFactor = Infinity; }
                const openTradesCount = allTrades.filter(t => t.status === 'open').length;
                totalPnlEl.textContent = `₹${totalPnl.toFixed(2)}`;
                totalPnlEl.className = totalPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                winRateEl.textContent = `${winRate.toFixed(1)}%`;
                avgWinLossEl.textContent = `₹${avgWin.toFixed(0)} / ₹${Math.abs(avgLoss).toFixed(0)}`;
                openTradesCountEl.textContent = openTradesCount;
                profitFactorEl.textContent = profitFactor === Infinity ? 'Perfect' : profitFactor.toFixed(2);
            };

            const renderTradesList = () => {
                let tradesToRender = allTrades.filter(t => currentView === 'open' ? t.status === 'open' : t.status !== 'open');
                
                if (selectedDateStr) {
                    tradesToRender = tradesToRender.filter(t => t.entryDate === selectedDateStr);
                    const formattedDate = new Date(selectedDateStr + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                    tradesListHeader.textContent = `Trades for ${formattedDate}`;
                    clearDateFilter.style.display = 'block';
                } else {
                    tradesListHeader.textContent = `${currentView.charAt(0).toUpperCase() + currentView.slice(1)} Trades`;
                    clearDateFilter.style.display = 'none';
                }

                tradesList.innerHTML = '';
                const sortedTrades = tradesToRender.sort((a,b) => new Date(b.entryDate) - new Date(a.entryDate));

                if (sortedTrades.length === 0) {
                    tradesList.innerHTML = `<li class="text-center text-slate-500 p-8 bg-white rounded-lg shadow-sm">No trades found for this view.</li>`;
                    return;
                }

                sortedTrades.forEach(trade => {
                    const li = document.createElement('li');
                    li.className = 'bg-white p-4 rounded-xl shadow-sm cursor-pointer transition-all duration-300';
                    li.dataset.tradeId = trade.id;

                    const pnlAmount = trade.pnl ? trade.pnl.toFixed(2) : 0;
                    const pnlPercent = trade.pnl ? ((trade.exitPrice - trade.entryPrice) / trade.entryPrice * 100 * (trade.direction === 'Short' ? -1 : 1)).toFixed(2) : 0;
                    const pnlClass = trade.pnl > 0 ? 'pnl-positive' : 'pnl-negative';
                    const tradeDetailsHtml = trade.status === 'open' ? `<div class="text-sm"><strong>Qty:</strong> ${trade.quantity} @ ₹${trade.entryPrice}</div>` : `<div class="text-sm"><strong>Exit:</strong> ${trade.exitDate} @ ₹${trade.exitPrice}</div><div class="text-lg font-bold ${pnlClass}">₹${pnlAmount} (${pnlPercent}%)</div>`;
                    
                    let notesHtml = '';
                    if (trade.dailyNotes && trade.dailyNotes.length > 0) {
                        notesHtml = `
                        <div class="trade-notes-container mt-4 pt-4 border-t border-slate-200" style="display: none;">
                            <h4 class="font-semibold text-sm mb-2 text-slate-600">Daily Journal</h4>
                            <ul class="space-y-2 text-sm">
                                ${trade.dailyNotes.sort((a,b) => new Date(b.date) - new Date(a.date)).map(note => `
                                    <li class="p-2 bg-slate-50 rounded-md">
                                        <strong class="text-slate-800">${new Date(note.date + 'T00:00:00').toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'})}:</strong>
                                        <p class="text-slate-600 whitespace-pre-wrap">${note.text}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    const actionButtons = `
                        ${trade.status === 'open' ? `<button class="add-note-btn bg-blue-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-blue-600" data-id="${trade.id}" aria-label="Add Note">Add Note</button>` : ''}
                        ${trade.status === 'open' ? `<button class="close-trade-btn bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-red-600" data-id="${trade.id}" aria-label="Close Trade">Close</button>` : ''}
                        <button class="edit-trade-btn bg-slate-200 text-slate-700 text-sm font-semibold py-1 px-3 rounded-md hover:bg-slate-300" data-id="${trade.id}" aria-label="Edit Trade">Edit</button>
                        <button class="delete-trade-btn text-slate-400 hover:text-red-500" data-id="${trade.id}" aria-label="Delete Trade">🗑️</button>`;

                    li.innerHTML = `
                        <div class="grid grid-cols-3 md:grid-cols-5 gap-4 items-center">
                            <div class="col-span-3 md:col-span-1">
                                <p class="font-bold text-xl text-indigo-700">${trade.ticker}</p>
                                <p class="text-sm text-slate-500">${trade.strategy}</p>
                            </div>
                            <div class="md:col-span-2">
                                <div class="text-sm"><strong>Entry:</strong> ${trade.entryDate}</div>
                                ${tradeDetailsHtml}
                            </div>
                            <div class="text-center">
                                <span class="status-tag status-${trade.status}">${trade.status}</span>
                            </div>
                            <div class="flex flex-wrap justify-end gap-2">${actionButtons}</div>
                        </div>
                        ${notesHtml}
                    `;
                    tradesList.appendChild(li);
                });
            };

            const renderCalendar = () => {
                calendarBody.innerHTML = '';
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                monthYearElement.textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayStr = new Date().toISOString().split('T')[0];

                for (let i = 0; i < firstDay; i++) { calendarBody.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`); }
                
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayCell = document.createElement('div');
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayCell.className = 'calendar-day';
                    dayCell.dataset.date = dateStr;
                    if (dateStr === todayStr) dayCell.classList.add('today');
                    if (dateStr === selectedDateStr) dayCell.classList.add('selected');

                    const tradesOnDay = allTrades.filter(t => t.entryDate === dateStr);
                    const buys = tradesOnDay.filter(t => t.direction === 'Long').length;
                    const sells = tradesOnDay.filter(t => t.direction === 'Short').length;

                    let tradesHtml = '';
                    if(buys > 0 || sells > 0) {
                        tradesHtml = `<div class="trades">`;
                        if (buys > 0) tradesHtml += `<span class="buys">▲${buys}</span>`;
                        if (sells > 0) tradesHtml += `<span class="sells">▼${sells}</span>`;
                        tradesHtml += `</div>`;
                    }
                    dayCell.innerHTML = `<span>${i}</span>${tradesHtml}`;
                    calendarBody.appendChild(dayCell);
                }
            };
            
            const renderCharts = () => {
                const closedTrades = allTrades.filter(t => t.status !== 'open').sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate));
                if (cumulativePnlChart) cumulativePnlChart.destroy();
                const pnlCtx = document.getElementById('cumulative-pnl-chart').getContext('2d');
                let cumulativePnl = 0;
                const pnlData = closedTrades.map(t => cumulativePnl += t.pnl);
                cumulativePnlChart = new Chart(pnlCtx, { type: 'line', data: { labels: closedTrades.map((t, i) => `Trade ${i + 1}`), datasets: [{ label: 'Cumulative P&L', data: pnlData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.1 }] } });
                if (strategyPnlChart) strategyPnlChart.destroy();
                const strategyCtx = document.getElementById('strategy-pnl-chart').getContext('2d');
                const strategyPnl = {};
                closedTrades.forEach(t => { const strategy = t.strategy || 'Uncategorized'; if (!strategyPnl[strategy]) strategyPnl[strategy] = 0; strategyPnl[strategy] += t.pnl; });
                strategyPnlChart = new Chart(strategyCtx, { type: 'bar', data: { labels: Object.keys(strategyPnl), datasets: [{ label: 'Total P&L by Strategy', data: Object.values(strategyPnl), backgroundColor: Object.values(strategyPnl).map(pnl => pnl >= 0 ? 'rgba(22, 163, 74, 0.7)' : 'rgba(220, 38, 38, 0.7)'), borderColor: Object.values(strategyPnl).map(pnl => pnl >= 0 ? '#166534' : '#991b1b'), borderWidth: 1 }] }, options: { indexAxis: 'y' } });
            };

            // --- MODAL & VIEW CONTROLS ---
            const showTradeModal = (trade = null) => {
                tradeForm.reset();
                if (trade) {
                    tradeModalTitle.textContent = 'Edit Trade'; tradeIdInput.value = trade.id;
                    document.getElementById('ticker-input').value = trade.ticker; document.getElementById('strategy-input').value = trade.strategy;
                    document.getElementById('entry-date-input').value = trade.entryDate; document.getElementById('direction-select').value = trade.direction;
                    document.getElementById('entry-price-input').value = trade.entryPrice; document.getElementById('quantity-input').value = trade.quantity;
                    document.getElementById('entry-notes-input').value = trade.entryNotes;
                } else {
                    tradeModalTitle.textContent = 'Log New Trade'; tradeIdInput.value = '';
                    document.getElementById('entry-date-input').value = new Date().toISOString().split('T')[0];
                }
                tradeModalOverlay.style.display = 'flex';
            };
            const hideTradeModal = () => { tradeModalOverlay.style.display = 'none'; };
            
            const showCloseTradeModal = (tradeId) => {
                closeTradeForm.reset(); closeTradeIdInput.value = tradeId;
                document.getElementById('exit-date-input').value = new Date().toISOString().split('T')[0];
                closeTradeModalOverlay.style.display = 'flex';
            };
            const hideCloseTradeModal = () => { closeTradeModalOverlay.style.display = 'none'; };
            
            const showAddNoteModal = (tradeId) => {
                const trade = allTrades.find(t => t.id == tradeId);
                if (!trade) return;
                addNoteForm.reset();
                addNoteTradeIdInput.value = tradeId;
                document.getElementById('add-note-modal-title').textContent = `Add Note for ${trade.ticker}`;
                document.getElementById('note-date-input').value = new Date().toISOString().split('T')[0];
                addNoteModalOverlay.style.display = 'flex';
            };
            const hideAddNoteModal = () => { addNoteModalOverlay.style.display = 'none'; };

            const showReportsModal = () => { reportsModalOverlay.style.display = 'flex'; };
            const hideReportsModal = () => { reportsModalOverlay.style.display = 'none'; };

            // --- EVENT LISTENERS ---
            logTradeButton.addEventListener('click', () => showTradeModal());
            closeTradeModalButton.addEventListener('click', hideTradeModal);
            tradeForm.addEventListener('submit', (e) => { e.preventDefault(); saveTrade(); });
            cancelCloseTradeButton.addEventListener('click', hideCloseTradeModal);
            closeTradeForm.addEventListener('submit', (e) => { e.preventDefault(); closeTrade(); });
            viewReportsButton.addEventListener('click', showReportsModal);
            closeReportsModalButton.addEventListener('click', hideReportsModal);
            addNoteForm.addEventListener('submit', (e) => { e.preventDefault(); saveNote(); });
            cancelAddNoteButton.addEventListener('click', hideAddNoteModal);
            
            tradesList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('button')) { e.stopPropagation(); }
                if (target.closest('.edit-trade-btn')) { const tradeId = target.closest('.edit-trade-btn').dataset.id; const trade = allTrades.find(t => t.id == tradeId); showTradeModal(trade); } 
                else if (target.closest('.add-note-btn')) { const tradeId = target.closest('.add-note-btn').dataset.id; showAddNoteModal(tradeId); } 
                else if (target.closest('.close-trade-btn')) { const tradeId = target.closest('.close-trade-btn').dataset.id; showCloseTradeModal(tradeId); } 
                else if (target.closest('.delete-trade-btn')) { const tradeId = target.closest('.delete-trade-btn').dataset.id; deleteTrade(tradeId); } 
                else if (target.closest('li[data-trade-id]')) { const notesContainer = target.closest('li').querySelector('.trade-notes-container'); if (notesContainer) { const isVisible = notesContainer.style.display === 'block'; notesContainer.style.display = isVisible ? 'none' : 'block'; } }
            });

            openTradesTab.addEventListener('click', () => { currentView = 'open'; openTradesTab.classList.add('active'); closedTradesTab.classList.remove('active'); renderTradesList(); });
            closedTradesTab.addEventListener('click', () => { currentView = 'closed'; closedTradesTab.classList.add('active'); openTradesTab.classList.remove('active'); renderTradesList(); });

            // Calendar Listeners
            prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
            calendarBody.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.calendar-day');
                if (dayCell?.dataset.date) {
                    selectedDateStr = dayCell.dataset.date;
                    renderTradesList();
                    renderCalendar();
                }
            });
            clearDateFilter.addEventListener('click', () => {
                selectedDateStr = null;
                renderTradesList();
                renderCalendar();
            });

            // --- INITIALIZATION ---
            dateElement.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        });
    </script>
</body>
</html>
